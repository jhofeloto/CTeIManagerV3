<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Completo - Workflow Editar Proyecto</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; }
        .step { margin: 15px 0; padding: 15px; border: 1px solid #ccc; background: white; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        .warning { background-color: #fff3cd; border-color: #ffeaa7; }
        button { padding: 10px 16px; margin: 5px; border: none; border-radius: 4px; cursor: pointer; }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-warning { background: #ffc107; color: black; }
        .btn-danger { background: #dc3545; color: white; }
        .project-card { margin: 10px 0; padding: 15px; border: 1px solid #ddd; background: #f8f9fa; border-radius: 5px; }
        .project-actions { margin-top: 10px; }
        .project-actions button { margin: 0 5px 5px 0; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 3px; overflow-x: auto; }
        .logs { max-height: 300px; overflow-y: auto; background: #f8f9fa; padding: 10px; border-radius: 3px; font-family: monospace; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Test Completo - Workflow Editar Proyecto</h1>
        <p><strong>Objetivo:</strong> Probar el workflow completo desde login hasta editar proyecto, tal como lo har√≠a un usuario real.</p>

        <div class="step info">
            <h3>üìã Paso 1: Autenticaci√≥n</h3>
            <p>Simular login con credenciales de test</p>
            <button class="btn-primary" onclick="performLogin()">üîë Login (test2@admin.com)</button>
            <div id="loginStatus"></div>
        </div>

        <div class="step info">
            <h3>üìä Paso 2: Cargar Proyectos (Simular Dashboard)</h3>
            <p>Cargar lista de proyectos como lo har√≠a el dashboard</p>
            <button class="btn-primary" onclick="loadMyProjects()">üìÇ Cargar Mis Proyectos</button>
            <div id="projectsStatus"></div>
        </div>

        <div class="step info">
            <h3>üéØ Paso 3: Test Bot√≥n "Editar Proyecto"</h3>
            <p>Simular clic en el bot√≥n "Editar Proyecto" del dashboard</p>
            <div id="projectsList"></div>
        </div>

        <div class="step info">
            <h3>üîç Paso 4: Verificar P√°gina de Edici√≥n</h3>
            <p>Verificar que la p√°gina de edici√≥n carga correctamente</p>
            <div id="editPageStatus"></div>
        </div>

        <div class="step info">
            <h3>üìù Logs del Proceso</h3>
            <div class="logs" id="processLogs"></div>
        </div>
    </div>

    <script>
        const API_BASE = '/api';
        let currentUser = null;
        let currentToken = null;
        let userProjects = [];

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logs = document.getElementById('processLogs');
            const icon = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
            logs.innerHTML += `<div>[${timestamp}] ${icon} ${message}</div>`;
            logs.scrollTop = logs.scrollBottom;
            console.log(`[${timestamp}] ${message}`);
        }

        async function performLogin() {
            try {
                log('Iniciando proceso de login...');
                
                const loginData = {
                    email: 'test2@admin.com',
                    password: 'password123'
                };

                log(`Enviando credenciales: ${loginData.email}`);
                
                const response = await axios.post(`${API_BASE}/auth/login`, loginData);
                
                if (response.data.success && response.data.data.token) {
                    currentToken = response.data.data.token;
                    currentUser = response.data.data.user;
                    
                    // Configurar axios con el token
                    axios.defaults.headers.common['Authorization'] = `Bearer ${currentToken}`;
                    
                    // Simular localStorage como en el dashboard real
                    localStorage.setItem('auth_token', currentToken);
                    
                    log(`Login exitoso! Usuario: ${currentUser.full_name} (${currentUser.role})`, 'success');
                    log(`Token JWT obtenido (primeros 50 chars): ${currentToken.substring(0, 50)}...`);
                    
                    document.getElementById('loginStatus').innerHTML = 
                        `<div class="success"><strong>‚úÖ Login Exitoso</strong><br>
                        Usuario: ${currentUser.full_name}<br>
                        Email: ${currentUser.email}<br>
                        Rol: ${currentUser.role}<br>
                        Token: ${currentToken.substring(0, 30)}...</div>`;
                } else {
                    throw new Error('Respuesta de login inv√°lida');
                }
                
            } catch (error) {
                log(`Error en login: ${error.message}`, 'error');
                document.getElementById('loginStatus').innerHTML = 
                    `<div class="error"><strong>‚ùå Error en Login</strong><br>${error.message}</div>`;
            }
        }

        async function loadMyProjects() {
            if (!currentToken) {
                log('No hay token disponible. Realizar login primero.', 'error');
                return;
            }

            try {
                log('Cargando proyectos del usuario...');
                
                const response = await axios.get(`${API_BASE}/private/projects`, {
                    headers: { 'Authorization': `Bearer ${currentToken}` }
                });

                userProjects = response.data || [];
                log(`Proyectos cargados: ${userProjects.length}`, 'success');

                if (userProjects.length > 0) {
                    log(`Primer proyecto: "${userProjects[0].title}" (ID: ${userProjects[0].id})`);
                    displayProjects(userProjects);
                    
                    document.getElementById('projectsStatus').innerHTML = 
                        `<div class="success"><strong>‚úÖ ${userProjects.length} proyectos cargados</strong></div>`;
                } else {
                    log('No se encontraron proyectos para este usuario', 'warning');
                    document.getElementById('projectsStatus').innerHTML = 
                        `<div class="warning"><strong>‚ö†Ô∏è No hay proyectos disponibles</strong></div>`;
                }

            } catch (error) {
                log(`Error cargando proyectos: ${error.response?.status} - ${error.response?.statusText || error.message}`, 'error');
                document.getElementById('projectsStatus').innerHTML = 
                    `<div class="error"><strong>‚ùå Error cargando proyectos</strong><br>${error.message}</div>`;
            }
        }

        function displayProjects(projects) {
            const container = document.getElementById('projectsList');
            
            if (projects.length === 0) {
                container.innerHTML = '<div class="warning">No hay proyectos para mostrar</div>';
                return;
            }

            container.innerHTML = '<h4>üìÇ Proyectos Disponibles:</h4>';

            projects.forEach(project => {
                const card = document.createElement('div');
                card.className = 'project-card';
                card.innerHTML = `
                    <h5><strong>${project.title || 'Sin t√≠tulo'}</strong></h5>
                    <p><strong>ID:</strong> ${project.id}</p>
                    <p><strong>Abstract:</strong> ${(project.abstract || 'Sin abstract').substring(0, 100)}${project.abstract?.length > 100 ? '...' : ''}</p>
                    <p><strong>Estado:</strong> ${project.status || 'Sin estado'}</p>
                    <p><strong>Propietario:</strong> ${project.owner_id}</p>
                    
                    <div class="project-actions">
                        <button class="btn-success" onclick="simulateEditClick(${project.id})">
                            ‚úèÔ∏è Editar Proyecto (Simular Dashboard)
                        </button>
                        <button class="btn-warning" onclick="testDirectEditAccess(${project.id})">
                            üîç Test Acceso Directo
                        </button>
                        <button class="btn-danger" onclick="debugEditIssue(${project.id})">
                            üêõ Debug Completo
                        </button>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function simulateEditClick(projectId) {
            log(`üñ±Ô∏è Simulando clic en "Editar Proyecto" para ID ${projectId}...`);
            
            // Esta es la funci√≥n EXACTA que usa el dashboard
            function editProject(projectId) {
                console.log(`Editando proyecto con ID: ${projectId}`);
                window.location.href = `/dashboard/proyectos/${projectId}/editar`;
            }
            
            log(`Ejecutando: window.location.href = "/dashboard/proyectos/${projectId}/editar"`);
            
            // En lugar de redirigir, vamos a hacer una petici√≥n para verificar
            testDirectEditAccess(projectId);
        }

        async function testDirectEditAccess(projectId) {
            if (!currentToken) {
                log('No hay token para test directo', 'error');
                return;
            }

            try {
                log(`üîç Probando acceso directo a /dashboard/proyectos/${projectId}/editar...`);
                
                const editUrl = `/dashboard/proyectos/${projectId}/editar`;
                const response = await axios.get(editUrl, {
                    headers: { 'Authorization': `Bearer ${currentToken}` }
                });

                log(`‚úÖ P√°gina de edici√≥n carga correctamente! Status: ${response.status}`, 'success');
                log(`Content-Type: ${response.headers['content-type']}`);
                log(`Response length: ${response.data.length} chars`);

                // Verificar que sea HTML v√°lido
                if (response.data.includes('<title>') && response.data.includes('Editar Proyecto')) {
                    log('‚úÖ HTML v√°lido con t√≠tulo correcto detectado', 'success');
                    
                    document.getElementById('editPageStatus').innerHTML = 
                        `<div class="success"><strong>‚úÖ P√°gina de Edici√≥n OK</strong><br>
                        URL: ${editUrl}<br>
                        Status: ${response.status}<br>
                        Content-Type: ${response.headers['content-type']}<br>
                        Contiene formulario de edici√≥n: ${response.data.includes('editProjectTitle') ? 'S√ç' : 'NO'}</div>`;
                } else {
                    log('‚ö†Ô∏è Respuesta recibida pero el HTML parece incorrecto', 'warning');
                }

            } catch (error) {
                log(`‚ùå Error accediendo a p√°gina de edici√≥n: ${error.response?.status} - ${error.response?.statusText}`, 'error');
                
                if (error.response?.status === 401) {
                    log('üîí Error 401: Problema de autenticaci√≥n', 'error');
                } else if (error.response?.status === 404) {
                    log('üö´ Error 404: Ruta no encontrada', 'error');
                } else if (error.response?.status === 403) {
                    log('üõ°Ô∏è Error 403: Sin permisos', 'error');
                }
                
                document.getElementById('editPageStatus').innerHTML = 
                    `<div class="error"><strong>‚ùå Error ${error.response?.status || 'Unknown'}</strong><br>${error.message}</div>`;
            }
        }

        async function debugEditIssue(projectId) {
            log(`üêõ Iniciando debug completo para proyecto ID ${projectId}...`);
            
            // 1. Verificar token
            if (!currentToken) {
                log('‚ùå DEBUG: No hay token actual', 'error');
                return;
            }
            log(`‚úÖ DEBUG: Token disponible (${currentToken.length} chars)`);

            // 2. Verificar proyecto existe
            const project = userProjects.find(p => p.id === projectId);
            if (!project) {
                log(`‚ùå DEBUG: Proyecto ID ${projectId} no encontrado en lista local`, 'error');
                return;
            }
            log(`‚úÖ DEBUG: Proyecto encontrado: "${project.title}"`);

            // 3. Test API de proyecto espec√≠fico
            try {
                log(`üîç DEBUG: Probando GET /api/private/projects/${projectId}...`);
                const projectResponse = await axios.get(`${API_BASE}/private/projects/${projectId}`, {
                    headers: { 'Authorization': `Bearer ${currentToken}` }
                });
                log(`‚úÖ DEBUG: Proyecto API response OK (${projectResponse.status})`, 'success');
            } catch (error) {
                log(`‚ùå DEBUG: Error en API proyecto individual: ${error.response?.status}`, 'error');
            }

            // 4. Test ruta de edici√≥n
            await testDirectEditAccess(projectId);

            // 5. Test simulaci√≥n de dashboard.js
            log(`üéØ DEBUG: Simulando funci√≥n dashboard.js editProject(${projectId})`);
            log(`‚û°Ô∏è DEBUG: Esto deber√≠a redirigir a: /dashboard/proyectos/${projectId}/editar`);
        }

        // Auto-setup
        window.addEventListener('load', () => {
            log('üöÄ Test workflow iniciado');
            log('üìñ Instrucciones: 1) Login ‚Üí 2) Cargar Proyectos ‚Üí 3) Test Editar');
        });
    </script>
</body>
</html>