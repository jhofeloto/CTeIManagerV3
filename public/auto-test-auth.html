<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auto Test Auth</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto bg-white p-6 rounded-lg shadow">
        <h1 class="text-2xl font-bold mb-4">ğŸš€ Test AutomÃ¡tico de AutenticaciÃ³n</h1>
        
        <div class="bg-black text-green-400 p-4 rounded font-mono text-sm h-96 overflow-y-auto" id="results">
            Iniciando test automÃ¡tico...<br>
        </div>
        
        <div class="mt-4">
            <button onclick="goToEditPage()" class="bg-blue-600 text-white px-6 py-3 rounded hover:bg-blue-700">
                ğŸ“ Ir a PÃ¡gina de EdiciÃ³n Ahora
            </button>
        </div>
    </div>

    <script>
        const API_BASE = '/api';
        const TEST_TOKEN = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOjIsImVtYWlsIjoiY2FybG9zLnJvZHJpZ3VlekBjdGVpLmVkdS5jbyIsInJvbGUiOiJJTlZFU1RJR0FUT1IiLCJleHAiOjE3NTc5ODYxNjl9.e2MHisoqWo3Q5g7M-91cbiJF6zR3OGKMjXIBnAdGCwI';
        let authToken = null;

        function log(message) {
            const results = document.getElementById('results');
            const timestamp = new Date().toLocaleTimeString();
            results.innerHTML += timestamp + ' > ' + message + '<br>';
            results.scrollTop = results.scrollHeight;
            console.log(message);
        }

        function runAutomaticTest() {
            log('ğŸš€ INICIANDO TEST AUTOMÃTICO COMPLETO');
            log('='.repeat(60));
            
            // PASO 1: Establecer token
            log('');
            log('ğŸ” PASO 1: ESTABLECIENDO TOKEN EN localStorage');
            localStorage.removeItem('auth_token');
            localStorage.setItem('auth_token', TEST_TOKEN);
            const storedToken = localStorage.getItem('auth_token');
            authToken = storedToken;
            log('âœ“ Token establecido y verificado: ' + (storedToken ? 'PRESENTE (' + storedToken.length + ' chars)' : 'AUSENTE'));
            
            // Decodificar token
            try {
                const parts = storedToken.split('.');
                const payload = JSON.parse(atob(parts[1]));
                log('âœ“ Usuario decodificado: ' + payload.email + ' (' + payload.role + ')');
                const expTime = new Date(payload.exp * 1000);
                const now = new Date();
                log('âœ“ Token expira: ' + expTime.toLocaleString() + ' (vÃ¡lido: ' + (expTime > now ? 'SÃ' : 'NO') + ')');
            } catch (e) {
                log('âŒ Error decodificando token: ' + e.message);
                return;
            }
            
            // PASO 2: Configurar Axios
            setTimeout(() => {
                log('');
                log('ğŸ” PASO 2: CONFIGURANDO AXIOS CON TOKEN');
                axios.defaults.headers.common['Authorization'] = 'Bearer ' + authToken;
                const authHeader = axios.defaults.headers.common['Authorization'];
                log('âœ“ Cabecera Authorization: ' + (authHeader ? 'CONFIGURADA' : 'NO CONFIGURADA'));
                log('âœ“ Valor de cabecera: ' + (authHeader || 'NINGUNA'));
                
                // Configurar interceptores
                axios.interceptors.request.use(
                    function(config) {
                        log('ğŸ“¤ REQUEST INTERCEPTOR: ' + config.method.toUpperCase() + ' ' + config.url);
                        log('ğŸ“¤ Auth header presente: ' + (config.headers.Authorization ? 'SÃ' : 'NO'));
                        if (config.headers.Authorization) {
                            log('ğŸ“¤ Auth value: ' + config.headers.Authorization.substring(0, 20) + '...');
                        }
                        return config;
                    },
                    function(error) {
                        log('âŒ REQUEST ERROR: ' + error.message);
                        return Promise.reject(error);
                    }
                );
                
                axios.interceptors.response.use(
                    function(response) {
                        log('ğŸ“¥ RESPONSE SUCCESS: Status ' + response.status + ' from ' + response.config.url);
                        return response;
                    },
                    function(error) {
                        log('âŒ RESPONSE ERROR: Status ' + (error.response ? error.response.status : 'N/A') + ' - ' + error.message);
                        return Promise.reject(error);
                    }
                );
                
                log('âœ“ Interceptores de axios configurados');
                
                // PASO 3: Probar API
                setTimeout(() => {
                    log('');
                    log('ğŸ” PASO 3: PROBANDO ENDPOINT DE API');
                    log('ğŸš€ Haciendo solicitud GET a: ' + API_BASE + '/private/projects/1');
                    
                    axios.get(API_BASE + '/private/projects/1')
                        .then(function(response) {
                            log('');
                            log('âœ… Â¡Ã‰XITO COMPLETO! API RESPONDIÃ“ CORRECTAMENTE');
                            log('âœ… Status HTTP: ' + response.status + ' ' + response.statusText);
                            log('âœ… Response success: ' + response.data.success);
                            
                            if (response.data.success && response.data.data) {
                                log('âœ… Proyecto cargado exitosamente:');
                                log('   - ID: ' + response.data.data.id);
                                log('   - TÃ­tulo: ' + response.data.data.title);
                                log('   - Propietario: ' + response.data.data.owner_name);
                                log('   - Email: ' + response.data.data.owner_email);
                                log('');
                                log('ğŸ‰ DIAGNÃ“STICO: TOKEN Y CONFIGURACIÃ“N FUNCIONAN CORRECTAMENTE');
                                log('ğŸ‰ El problema NO estÃ¡ en el token ni en axios.defaults');
                                log('');
                                log('ğŸ’¡ PRÃ“XIMO PASO: Verificar que la pÃ¡gina de ediciÃ³n use axios.defaults');
                                log('ğŸ’¡ O verificar si estÃ¡ usando una instancia diferente de axios');
                            }
                        })
                        .catch(function(error) {
                            log('');
                            log('âŒ ERROR EN API - AQUÃ ESTÃ EL PROBLEMA:');
                            if (error.response) {
                                log('âŒ Status HTTP: ' + error.response.status);
                                log('âŒ Mensaje: ' + (error.response.data ? JSON.stringify(error.response.data) : 'Sin mensaje'));
                                
                                if (error.response.status === 401) {
                                    log('âŒ DIAGNÃ“STICO: Token no enviado o invÃ¡lido');
                                    log('âŒ Verificar que axios.defaults.headers.common estÃ© configurado');
                                } else if (error.response.status === 403) {
                                    log('âŒ DIAGNÃ“STICO: Token vÃ¡lido pero sin permisos');
                                } else {
                                    log('âŒ DIAGNÃ“STICO: Error diferente - revisar backend');
                                }
                            } else {
                                log('âŒ Error de red: ' + error.message);
                                log('âŒ DIAGNÃ“STICO: Problema de conectividad o CORS');
                            }
                        });
                }, 1000);
            }, 1000);
        }

        function goToEditPage() {
            log('');
            log('ğŸš€ NAVEGANDO A PÃGINA DE EDICIÃ“N...');
            log('âœ“ Token ya estÃ¡ configurado en localStorage');
            log('âœ“ Axios ya estÃ¡ configurado con cabeceras');
            
            // PequeÃ±o delay para que se vean los logs
            setTimeout(() => {
                window.location.href = '/edit/1';
            }, 1000);
        }

        // Ejecutar automÃ¡ticamente al cargar
        document.addEventListener('DOMContentLoaded', function() {
            log('ğŸ”§ Sistema de test automÃ¡tico cargado');
            log('ğŸ”§ Dependencias verificadas:');
            log('   - Axios: ' + (typeof axios !== 'undefined' ? 'âœ“ Disponible' : 'âŒ No disponible'));
            log('   - localStorage: ' + (typeof localStorage !== 'undefined' ? 'âœ“ Disponible' : 'âŒ No disponible'));
            log('');
            
            // Iniciar test automÃ¡tico despuÃ©s de 2 segundos
            setTimeout(runAutomaticTest, 2000);
        });
    </script>
</body>
</html>