<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Test Edit Button with Auth</title>
    <script src="https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .product { border: 1px solid #ddd; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .button { padding: 10px 15px; margin: 5px; cursor: pointer; background: #007bff; color: white; border: none; border-radius: 3px; }
        .button:hover { background: #0056b3; }
        .log { background: #f5f5f5; padding: 10px; margin: 10px 0; border-radius: 3px; font-family: monospace; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
    </style>
</head>
<body>
    <h1>üß™ Test: Bot√≥n "Editar Producto" Autenticado</h1>
    
    <div id="authStatus" class="log">
        <h3>Estado de Autenticaci√≥n:</h3>
        <div id="authInfo">No autenticado</div>
    </div>

    <div id="loginSection">
        <h2>1. Login Autom√°tico</h2>
        <button onclick="autoLogin()" class="button">üîë Auto Login</button>
    </div>

    <div id="productsSection" style="display:none;">
        <h2>2. Mis Productos CTeI</h2>
        <div id="productsList"></div>
    </div>

    <div id="testSection" style="display:none;">
        <h2>3. Test Bot√≥n Editar</h2>
        <div id="testResults" class="log"></div>
    </div>

    <script>
        const API_BASE = '/api';
        let authToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOjk5OCwiZW1haWwiOiJ0ZXN0MkBhZG1pbi5jb20iLCJyb2xlIjoiQURNSU4iLCJleHAiOjE3NTgxNDE3MDJ9.CioalMXRtpAE2SLTSZHlRQrpq_wKh9U80x-qRiyyNqY';
        let userProducts = [];

        function log(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            element.innerHTML += `<div class="${type}">[${timestamp}] ${message}</div>`;
            console.log(`[${type}] ${message}`);
        }

        // Funci√≥n editProduct exactamente como est√° en dashboard.js
        function editProduct(projectId, productId) {
            // Redirigir a la p√°gina independiente de edici√≥n de producto
            log('testResults', `üîó editProduct llamada: projectId=${projectId}, productId=${productId}`, 'info');
            log('testResults', `üîó URL generada: /dashboard/productos/${productId}/editar`, 'info');
            
            // En lugar de redirigir realmente, vamos a verificar la URL
            fetch(`/dashboard/productos/${productId}/editar`, {
                method: 'HEAD',
                headers: {
                    'Authorization': `Bearer ${authToken}`
                }
            }).then(response => {
                log('testResults', `‚úÖ Verificaci√≥n URL: Status ${response.status} (${response.statusText})`, 
                    response.ok || response.status === 302 ? 'success' : 'error');
                
                if (response.ok || response.status === 302) {
                    log('testResults', `üéâ ¬°√âXITO! El bot√≥n "Editar Producto" funciona correctamente`, 'success');
                    log('testResults', `üîó Para probar realmente, abrir: /dashboard/productos/${productId}/editar`, 'info');
                }
            }).catch(error => {
                log('testResults', `‚ùå Error verificando URL: ${error.message}`, 'error');
            });
            
            // NO redirigir para mantener la p√°gina de test
            // window.location.href = `/dashboard/productos/${productId}/editar`;
        }

        async function autoLogin() {
            log('authInfo', 'üîÑ Configurando autenticaci√≥n...', 'info');
            
            if (authToken) {
                // Configurar axios con el token
                axios.defaults.headers.common['Authorization'] = `Bearer ${authToken}`;
                
                // Verificar que el token funcione
                try {
                    const response = await axios.get(`${API_BASE}/private/products`);
                    if (response.data.success) {
                        userProducts = response.data.products;
                        log('authInfo', `‚úÖ Autenticaci√≥n exitosa. ${userProducts.length} productos encontrados.`, 'success');
                        
                        document.getElementById('loginSection').style.display = 'none';
                        document.getElementById('productsSection').style.display = 'block';
                        document.getElementById('testSection').style.display = 'block';
                        
                        renderProducts();
                    } else {
                        log('authInfo', `‚ùå Token inv√°lido: ${response.data.error}`, 'error');
                    }
                } catch (error) {
                    log('authInfo', `‚ùå Error de autenticaci√≥n: ${error.message}`, 'error');
                }
            } else {
                log('authInfo', '‚ùå No hay token disponible', 'error');
            }
        }

        function renderProducts() {
            const container = document.getElementById('productsList');
            
            if (userProducts.length === 0) {
                container.innerHTML = '<p>No hay productos disponibles</p>';
                return;
            }

            container.innerHTML = userProducts.map(product => `
                <div class="product">
                    <h4>${product.description || 'Producto sin descripci√≥n'}</h4>
                    <p><strong>ID:</strong> ${product.id} | <strong>Proyecto:</strong> ${product.project_id}</p>
                    <p><strong>Tipo:</strong> ${product.product_type} | <strong>C√≥digo:</strong> ${product.product_code}</p>
                    <button 
                        onclick="editProduct(${product.project_id}, ${product.id})"
                        class="button"
                        title="Editar producto"
                    >
                        ‚úèÔ∏è Editar Producto
                    </button>
                    <button 
                        onclick="testEditURL(${product.id})"
                        class="button"
                        style="background: #28a745;"
                        title="Test directo de URL"
                    >
                        üîó Test URL
                    </button>
                </div>
            `).join('');

            log('testResults', `‚úÖ ${userProducts.length} productos renderizados con botones "Editar Producto"`, 'success');
        }

        async function testEditURL(productId) {
            log('testResults', `üîÑ Probando URL de edici√≥n directamente...`, 'info');
            
            const editURL = `/dashboard/productos/${productId}/editar`;
            
            try {
                const response = await fetch(editURL, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                log('testResults', `üîç URL: ${editURL}`, 'info');
                log('testResults', `üìä Status: ${response.status} (${response.statusText})`, 
                    response.ok ? 'success' : (response.status === 302 ? 'info' : 'error'));
                
                if (response.ok) {
                    const html = await response.text();
                    const hasEditForm = html.includes('Editar Producto');
                    const hasFileUpload = html.includes('file') || html.includes('upload');
                    
                    log('testResults', `‚úÖ P√°gina de edici√≥n accesible`, 'success');
                    log('testResults', `üìã Contiene formulario: ${hasEditForm ? '‚úÖ' : '‚ùå'}`, hasEditForm ? 'success' : 'error');
                    log('testResults', `üìÅ Soporte archivos: ${hasFileUpload ? '‚úÖ' : '‚ùå'}`, hasFileUpload ? 'success' : 'error');
                } else if (response.status === 302) {
                    log('testResults', `üîÑ Redirecci√≥n detectada (normal para rutas protegidas)`, 'info');
                }
                
            } catch (error) {
                log('testResults', `‚ùå Error accediendo a URL: ${error.message}`, 'error');
            }
        }

        // Auto-ejecutar al cargar
        window.onload = function() {
            log('authInfo', 'üöÄ Test iniciado. Token preconfigurado.', 'info');
            autoLogin();
        };
    </script>
</body>
</html>