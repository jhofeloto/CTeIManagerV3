<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Auth Flow</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto bg-white p-6 rounded-lg shadow">
        <h1 class="text-2xl font-bold mb-4">üîß Diagn√≥stico Completo de Autenticaci√≥n</h1>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Panel de Control -->
            <div class="bg-gray-50 p-4 rounded">
                <h2 class="text-lg font-semibold mb-4">Panel de Control</h2>
                <div class="space-y-3">
                    <button onclick="step1_setToken()" class="w-full bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                        1Ô∏è‚É£ Establecer Token
                    </button>
                    <button onclick="step2_configureAxios()" class="w-full bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
                        2Ô∏è‚É£ Configurar Axios
                    </button>
                    <button onclick="step3_testAPI()" class="w-full bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700">
                        3Ô∏è‚É£ Probar API
                    </button>
                    <button onclick="step4_fullTest()" class="w-full bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700">
                        üöÄ Test Completo
                    </button>
                    <button onclick="clearAll()" class="w-full bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700">
                        üóëÔ∏è Limpiar Todo
                    </button>
                </div>
            </div>

            <!-- Resultados -->
            <div>
                <h2 class="text-lg font-semibold mb-4">Resultados</h2>
                <div id="results" class="bg-black text-green-400 p-4 rounded font-mono text-sm h-96 overflow-y-auto">
                    Esperando comandos...<br>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        const API_BASE = '/api';
        const TEST_TOKEN = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOjIsImVtYWlsIjoiY2FybG9zLnJvZHJpZ3VlekBjdGVpLmVkdS5jbyIsInJvbGUiOiJJTlZFU1RJR0FUT1IiLCJleHAiOjE3NTc5ODYxNjl9.e2MHisoqWo3Q5g7M-91cbiJF6zR3OGKMjXIBnAdGCwI';
        let authToken = null;

        function log(message) {
            const results = document.getElementById('results');
            const timestamp = new Date().toLocaleTimeString();
            results.innerHTML += timestamp + ' > ' + message + '<br>';
            results.scrollTop = results.scrollHeight;
            console.log(message);
        }

        function step1_setToken() {
            log('üîç PASO 1: ESTABLECIENDO TOKEN');
            
            // Limpiar localStorage primero
            localStorage.removeItem('auth_token');
            log('‚úì localStorage limpio');
            
            // Establecer token
            localStorage.setItem('auth_token', TEST_TOKEN);
            log('‚úì Token establecido en localStorage');
            
            // Verificar token
            const storedToken = localStorage.getItem('auth_token');
            log('‚úì Token verificado: ' + (storedToken ? 'PRESENTE' : 'AUSENTE'));
            log('‚úì Longitud: ' + (storedToken ? storedToken.length : 0));
            
            // Asignar a variable global
            authToken = storedToken;
            log('‚úì Variable global authToken actualizada');
            
            // Decodificar token para verificar
            try {
                const parts = storedToken.split('.');
                const payload = JSON.parse(atob(parts[1]));
                log('‚úì Token decodificado - Usuario: ' + payload.email + ' (' + payload.role + ')');
                log('‚úì Expira: ' + new Date(payload.exp * 1000).toLocaleString());
            } catch (e) {
                log('‚ùå Error decodificando token: ' + e.message);
            }
        }

        function step2_configureAxios() {
            log('üîç PASO 2: CONFIGURANDO AXIOS');
            
            if (!authToken) {
                log('‚ùå ERROR: No hay token disponible. Ejecuta Paso 1 primero.');
                return;
            }
            
            // Configurar cabecera Authorization
            axios.defaults.headers.common['Authorization'] = 'Bearer ' + authToken;
            log('‚úì Cabecera Authorization configurada');
            
            // Verificar configuraci√≥n
            const authHeader = axios.defaults.headers.common['Authorization'];
            log('‚úì Verificaci√≥n: ' + (authHeader ? 'CONFIGURADO' : 'NO CONFIGURADO'));
            log('‚úì Cabecera actual: ' + (authHeader || 'NINGUNA'));
            
            // Configurar interceptor de solicitudes
            axios.interceptors.request.use(
                function(config) {
                    log('üì§ INTERCEPTOR: Solicitud saliente a ' + config.url);
                    log('üì§ Auth header: ' + (config.headers.Authorization ? 'PRESENTE' : 'AUSENTE'));
                    return config;
                },
                function(error) {
                    log('‚ùå INTERCEPTOR: Error en solicitud: ' + error.message);
                    return Promise.reject(error);
                }
            );
            
            // Configurar interceptor de respuestas
            axios.interceptors.response.use(
                function(response) {
                    log('üì• INTERCEPTOR: Respuesta recibida - Status: ' + response.status);
                    return response;
                },
                function(error) {
                    log('‚ùå INTERCEPTOR: Error en respuesta: ' + (error.response ? error.response.status : error.message));
                    return Promise.reject(error);
                }
            );
            
            log('‚úì Interceptores configurados');
        }

        function step3_testAPI() {
            log('üîç PASO 3: PROBANDO API');
            
            if (!authToken) {
                log('‚ùå ERROR: No hay token disponible. Ejecuta Paso 1 primero.');
                return;
            }
            
            log('üöÄ Enviando solicitud a: ' + API_BASE + '/private/projects/1');
            
            // Hacer solicitud
            axios.get(API_BASE + '/private/projects/1')
                .then(function(response) {
                    log('‚úÖ √âXITO: Respuesta recibida');
                    log('‚úÖ Status: ' + response.status + ' ' + response.statusText);
                    log('‚úÖ Success: ' + response.data.success);
                    
                    if (response.data.success && response.data.data) {
                        log('‚úÖ Proyecto cargado: ' + response.data.data.title);
                        log('‚úÖ Propietario: ' + response.data.data.owner_name);
                    }
                })
                .catch(function(error) {
                    log('‚ùå ERROR: Fallo en API');
                    if (error.response) {
                        log('‚ùå Status: ' + error.response.status);
                        log('‚ùå Error: ' + (error.response.data ? error.response.data.error : 'Desconocido'));
                    } else {
                        log('‚ùå Error de red: ' + error.message);
                    }
                });
        }

        function step4_fullTest() {
            log('üöÄ INICIANDO TEST COMPLETO...');
            log('='.repeat(50));
            
            // Ejecutar todos los pasos en secuencia
            step1_setToken();
            
            setTimeout(function() {
                step2_configureAxios();
                
                setTimeout(function() {
                    step3_testAPI();
                }, 500);
            }, 500);
        }

        function clearAll() {
            log('üóëÔ∏è LIMPIANDO TODO...');
            
            // Limpiar localStorage
            localStorage.removeItem('auth_token');
            authToken = null;
            
            // Limpiar axios
            delete axios.defaults.headers.common['Authorization'];
            
            // Limpiar interceptores (esto reinicia axios)
            axios.interceptors.request.clear();
            axios.interceptors.response.clear();
            
            // Limpiar log
            setTimeout(function() {
                document.getElementById('results').innerHTML = 'Sistema limpio. Listo para nueva prueba.<br>';
            }, 1000);
            
            log('‚úì Todo limpiado');
        }

        // Auto-configurar en carga inicial
        document.addEventListener('DOMContentLoaded', function() {
            log('üîß Sistema de diagn√≥stico cargado');
            log('üîß Axios disponible: ' + (typeof axios !== 'undefined' ? 'S√ç' : 'NO'));
            log('üîß localStorage disponible: ' + (typeof localStorage !== 'undefined' ? 'S√ç' : 'NO'));
            log('');
            log('Instrucciones:');
            log('1. Ejecuta "1Ô∏è‚É£ Establecer Token" para configurar autenticaci√≥n');
            log('2. Ejecuta "2Ô∏è‚É£ Configurar Axios" para configurar cliente HTTP');
            log('3. Ejecuta "3Ô∏è‚É£ Probar API" para hacer solicitud');
            log('4. O usa "üöÄ Test Completo" para ejecutar todo autom√°ticamente');
            log('');
        });
    </script>
</body>
</html>