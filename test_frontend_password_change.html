<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Frontend Password Change</title>
    <script src="https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-2xl mx-auto bg-white p-6 rounded shadow">
        <h1 class="text-2xl font-bold mb-4">üîß Test Frontend Password Change</h1>
        
        <!-- Step 1: Admin Login -->
        <div class="mb-6 p-4 border rounded">
            <h2 class="text-lg font-semibold mb-2">Step 1: Admin Login</h2>
            <button onclick="adminLogin()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                Login as Admin
            </button>
            <div id="adminResult" class="mt-2 text-sm"></div>
        </div>

        <!-- Step 2: Change Password -->
        <div class="mb-6 p-4 border rounded">
            <h2 class="text-lg font-semibold mb-2">Step 2: Change Password</h2>
            <input type="text" id="newPassword" placeholder="Nueva contrase√±a" 
                   value="TestPassword456" class="border px-3 py-2 rounded mr-2">
            <button onclick="changePassword()" class="bg-orange-500 text-white px-4 py-2 rounded hover:bg-orange-600">
                Change Password
            </button>
            <div id="changeResult" class="mt-2 text-sm"></div>
        </div>

        <!-- Step 3: Test New Password -->
        <div class="mb-6 p-4 border rounded">
            <h2 class="text-lg font-semibold mb-2">Step 3: Test New Password</h2>
            <input type="text" id="testEmail" placeholder="Email" 
                   value="investigador.test@choco.gov.co" class="border px-3 py-2 rounded mr-2">
            <input type="text" id="testPassword" placeholder="Contrase√±a" 
                   value="TestPassword456" class="border px-3 py-2 rounded mr-2">
            <button onclick="testLogin()" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                Test Login
            </button>
            <div id="testResult" class="mt-2 text-sm"></div>
        </div>

        <!-- Reset Password -->
        <div class="mb-6 p-4 border rounded">
            <h2 class="text-lg font-semibold mb-2">Step 4: Reset to Original</h2>
            <button onclick="resetPassword()" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">
                Reset to ChocoCTeI2024
            </button>
            <div id="resetResult" class="mt-2 text-sm"></div>
        </div>
        
        <div id="logs" class="mt-4 p-3 bg-gray-100 rounded text-xs">
            <h3 class="font-bold mb-2">üìã Logs:</h3>
            <div id="logContent"></div>
        </div>
    </div>

    <script>
        const API_BASE = '/api';
        let adminToken = '';
        
        function log(message) {
            const logDiv = document.getElementById('logContent');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += '<div class="mb-1">' + timestamp + ': ' + message + '</div>';
            console.log(message);
        }

        async function adminLogin() {
            try {
                const response = await axios.post(`${API_BASE}/auth/login`, {
                    email: 'admin@test.com',
                    password: 'admin123'
                });
                
                if (response.data.success) {
                    adminToken = response.data.data.token;
                    document.getElementById('adminResult').innerHTML = 
                        '<span class="text-green-600">‚úÖ Admin login exitoso</span>';
                    log('‚úÖ Admin token obtenido');
                } else {
                    document.getElementById('adminResult').innerHTML = 
                        '<span class="text-red-600">‚ùå Error: ' + response.data.error + '</span>';
                }
            } catch (error) {
                log('‚ùå Error en admin login: ' + error.message);
                document.getElementById('adminResult').innerHTML = 
                    '<span class="text-red-600">‚ùå Error: ' + error.message + '</span>';
            }
        }

        async function changePassword() {
            if (!adminToken) {
                alert('Primero haz login como admin');
                return;
            }
            
            const newPassword = document.getElementById('newPassword').value;
            log(`üîß Cambiando contrase√±a a: "${newPassword}"`);
            
            try {
                const response = await axios.put(`${API_BASE}/admin/users/105/password`, {
                    new_password: newPassword
                }, {
                    headers: { Authorization: `Bearer ${adminToken}` }
                });
                
                if (response.data.success) {
                    document.getElementById('changeResult').innerHTML = 
                        '<span class="text-green-600">‚úÖ Contrase√±a cambiada exitosamente</span>';
                    document.getElementById('testPassword').value = newPassword;
                    log('‚úÖ Contrase√±a cambiada correctamente');
                } else {
                    document.getElementById('changeResult').innerHTML = 
                        '<span class="text-red-600">‚ùå Error: ' + response.data.error + '</span>';
                }
            } catch (error) {
                log('‚ùå Error cambiando contrase√±a: ' + error.message);
                document.getElementById('changeResult').innerHTML = 
                    '<span class="text-red-600">‚ùå Error: ' + error.message + '</span>';
            }
        }

        async function testLogin() {
            const email = document.getElementById('testEmail').value;
            const password = document.getElementById('testPassword').value;
            
            log(`üß™ Probando login con email: "${email}" y password: "${password}"`);
            log(`üìè Password length: ${password.length}`);
            log(`üîç Password chars: ${JSON.stringify([...password])}`);
            
            try {
                const response = await axios.post(`${API_BASE}/auth/login`, {
                    email: email,
                    password: password
                });
                
                log(`üì¶ Response: ${JSON.stringify(response.data)}`);
                
                if (response.data.success) {
                    document.getElementById('testResult').innerHTML = 
                        '<span class="text-green-600">‚úÖ Login exitoso con nueva contrase√±a</span>';
                    log('‚úÖ Login exitoso');
                } else {
                    document.getElementById('testResult').innerHTML = 
                        '<span class="text-red-600">‚ùå Login fall√≥: ' + response.data.error + '</span>';
                    log('‚ùå Login fall√≥: ' + response.data.error);
                }
            } catch (error) {
                log('‚ùå Error en test login: ' + error.message);
                document.getElementById('testResult').innerHTML = 
                    '<span class="text-red-600">‚ùå Error: ' + error.message + '</span>';
            }
        }

        async function resetPassword() {
            if (!adminToken) {
                alert('Primero haz login como admin');
                return;
            }
            
            try {
                const response = await axios.put(`${API_BASE}/admin/users/105/password`, {
                    new_password: 'ChocoCTeI2024'
                }, {
                    headers: { Authorization: `Bearer ${adminToken}` }
                });
                
                if (response.data.success) {
                    document.getElementById('resetResult').innerHTML = 
                        '<span class="text-green-600">‚úÖ Contrase√±a restaurada a ChocoCTeI2024</span>';
                    log('‚úÖ Contrase√±a restaurada');
                } else {
                    document.getElementById('resetResult').innerHTML = 
                        '<span class="text-red-600">‚ùå Error: ' + response.data.error + '</span>';
                }
            } catch (error) {
                log('‚ùå Error restaurando contrase√±a: ' + error.message);
                document.getElementById('resetResult').innerHTML = 
                    '<span class="text-red-600">‚ùå Error: ' + error.message + '</span>';
            }
        }
        
        log('üöÄ Test page loaded');
    </script>
</body>
</html>