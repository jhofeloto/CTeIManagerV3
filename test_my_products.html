<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test - Mis Productos CTeI-Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .test-result { padding: 10px; margin: 5px; border-radius: 5px; }
        .success { background-color: #dcfce7; border-left: 4px solid #22c55e; }
        .error { background-color: #fef2f2; border-left: 4px solid #ef4444; }
        .info { background-color: #e0f2fe; border-left: 4px solid #06b6d4; }
    </style>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-6xl mx-auto">
        <h1 class="text-3xl font-bold mb-6">ğŸ§ª Test - Nueva Funcionalidad "Mis Productos"</h1>
        
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
            <!-- Panel de Login -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-semibold mb-4">ğŸ” AutenticaciÃ³n</h2>
                <button onclick="testLogin()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 mr-2">
                    Hacer Login
                </button>
                <button onclick="testLogout()" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">
                    Logout
                </button>
                <div id="auth-status" class="mt-4"></div>
            </div>

            <!-- Panel de Acceso -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-semibold mb-4">ğŸ¯ Acceso RÃ¡pido</h2>
                <div class="space-y-2">
                    <a href="/dashboard" target="_blank" class="block bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 text-center">
                        ğŸ›ï¸ Ir al Dashboard
                    </a>
                    <button onclick="testMisProductosAPI()" class="w-full bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600">
                        ğŸ§ª Test API Mis Productos
                    </button>
                    <button onclick="testCategorias()" class="w-full bg-orange-500 text-white px-4 py-2 rounded hover:bg-orange-600">
                        ğŸ“‹ Test Carga de CategorÃ­as
                    </button>
                </div>
            </div>
        </div>

        <!-- Panel de Tests -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">ğŸš€ Tests EspecÃ­ficos</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <button onclick="testEditProduct()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                    âœï¸ Test Editar Producto
                </button>
                <button onclick="testToggleVisibility()" class="bg-orange-500 text-white px-4 py-2 rounded hover:bg-orange-600">
                    ğŸ‘ï¸ Test Publicar/Ocultar
                </button>
                <button onclick="testDeleteProduct()" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">
                    ğŸ—‘ï¸ Test Eliminar Producto
                </button>
            </div>
        </div>

        <!-- Resultados de Tests -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-semibold mb-4">ğŸ“Š Resultados de Tests</h2>
            <div id="test-results"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js"></script>
    <script>
        let authToken = null;
        let testProducts = [];
        let testCategories = [];
        
        function addTestResult(message, type = 'info') {
            const resultsDiv = document.getElementById('test-results');
            const resultDiv = document.createElement('div');
            resultDiv.className = `test-result ${type}`;
            resultDiv.innerHTML = `<strong>${new Date().toLocaleTimeString()}</strong>: ${message}`;
            resultsDiv.appendChild(resultDiv);
            resultsDiv.scrollTop = resultsDiv.scrollHeight;
        }

        function updateAuthStatus() {
            const statusDiv = document.getElementById('auth-status');
            if (authToken) {
                statusDiv.innerHTML = '<span class="text-green-600">âœ… Autenticado correctamente</span>';
                axios.defaults.headers.common['Authorization'] = `Bearer ${authToken}`;
            } else {
                statusDiv.innerHTML = '<span class="text-red-600">âŒ No autenticado</span>';
                delete axios.defaults.headers.common['Authorization'];
            }
        }

        async function testLogin() {
            try {
                addTestResult('Intentando hacer login...', 'info');
                const response = await axios.post('/api/auth/login', {
                    email: 'carlos.rodriguez@ctei.edu.co',
                    password: 'password123'
                });
                
                if (response.data.success) {
                    authToken = response.data.data.token;
                    addTestResult(`âœ… Login exitoso para ${response.data.data.user.full_name}`, 'success');
                    updateAuthStatus();
                } else {
                    addTestResult('âŒ Login fallido: ' + response.data.error, 'error');
                }
            } catch (error) {
                addTestResult('âŒ Error en login: ' + error.message, 'error');
            }
        }

        function testLogout() {
            authToken = null;
            addTestResult('âœ… Logout exitoso', 'info');
            updateAuthStatus();
        }

        async function testMisProductosAPI() {
            if (!authToken) {
                addTestResult('âŒ Error: Debes hacer login primero', 'error');
                return;
            }

            try {
                addTestResult('ğŸ” Cargando proyectos y productos...', 'info');
                
                // 1. Cargar proyectos
                const projectsResponse = await axios.get('/api/me/projects');
                if (!projectsResponse.data.success) {
                    throw new Error('Error cargando proyectos');
                }
                
                const projects = projectsResponse.data.data.projects;
                addTestResult(`âœ… Cargados ${projects.length} proyectos`, 'success');
                
                // 2. Cargar productos de cada proyecto
                let allProducts = [];
                for (const project of projects) {
                    try {
                        const productsResponse = await axios.get(`/api/me/projects/${project.id}/products`);
                        if (productsResponse.data.success) {
                            const products = productsResponse.data.data.products.map(p => ({
                                ...p,
                                project_title: project.title,
                                project_id: project.id
                            }));
                            allProducts = allProducts.concat(products);
                        }
                    } catch (error) {
                        addTestResult(`âš ï¸ Error cargando productos del proyecto ${project.id}: ${error.message}`, 'error');
                    }
                }
                
                testProducts = allProducts;
                addTestResult(`âœ… TOTAL: ${allProducts.length} productos encontrados`, 'success');
                
                // 3. Mostrar detalles de productos
                allProducts.forEach((product, index) => {
                    const status = product.is_public ? 'PÃºblico' : 'Privado';
                    const creator = product.creator_name || 'N/A';
                    addTestResult(`${index + 1}. ${product.product_code} (${status}) - Creador: ${creator} - Proyecto: ${product.project_title}`, 'info');
                });
                
            } catch (error) {
                addTestResult('âŒ Error cargando productos: ' + error.message, 'error');
            }
        }

        async function testCategorias() {
            try {
                addTestResult('ğŸ“‹ Cargando categorÃ­as de productos...', 'info');
                
                const response = await axios.get('/api/public/product-categories');
                if (response.data.success) {
                    testCategories = response.data.data.categories;
                    addTestResult(`âœ… Cargadas ${testCategories.length} categorÃ­as`, 'success');
                    
                    // Agrupar por category_group
                    const groups = {};
                    testCategories.forEach(cat => {
                        if (!groups[cat.category_group]) {
                            groups[cat.category_group] = [];
                        }
                        groups[cat.category_group].push(cat);
                    });
                    
                    Object.keys(groups).forEach(group => {
                        addTestResult(`ğŸ“‚ ${group}: ${groups[group].length} categorÃ­as`, 'info');
                    });
                    
                    addTestResult('âœ… Test de categorÃ­as completado - Modal de ediciÃ³n deberÃ­a funcionar', 'success');
                } else {
                    addTestResult('âŒ Error cargando categorÃ­as: ' + response.data.error, 'error');
                }
            } catch (error) {
                addTestResult('âŒ Error cargando categorÃ­as: ' + error.message, 'error');
            }
        }

        async function testEditProduct() {
            if (!authToken) {
                addTestResult('âŒ Error: Debes hacer login primero', 'error');
                return;
            }

            if (testProducts.length === 0) {
                addTestResult('âš ï¸ Primero ejecuta "Test API Mis Productos" para cargar productos', 'error');
                return;
            }

            const product = testProducts[0];
            addTestResult(`âœï¸ Simulando ediciÃ³n del producto: ${product.product_code}`, 'info');
            addTestResult(`ğŸ“ ID del producto: ${product.id}, Proyecto: ${product.project_id}`, 'info');
            addTestResult(`ğŸ“‚ CategorÃ­a actual: ${product.product_type} (${product.category_name || 'Sin nombre'})`, 'info');
            addTestResult('âœ… Los datos estÃ¡n listos - La ediciÃ³n funcionarÃ­a correctamente', 'success');
            addTestResult('ğŸ’¡ Puedes ir al Dashboard y probar la ediciÃ³n real desde "Mis Productos"', 'info');
        }

        async function testToggleVisibility() {
            if (!authToken) {
                addTestResult('âŒ Error: Debes hacer login primero', 'error');
                return;
            }

            if (testProducts.length === 0) {
                addTestResult('âš ï¸ Primero ejecuta "Test API Mis Productos" para cargar productos', 'error');
                return;
            }

            try {
                const product = testProducts[0];
                const newVisibility = !product.is_public;
                
                addTestResult(`ğŸ‘ï¸ Cambiando visibilidad del producto ${product.product_code} a ${newVisibility ? 'PÃšBLICO' : 'PRIVADO'}...`, 'info');
                
                const response = await axios.post(`/api/me/projects/${product.project_id}/products/${product.id}/publish`, {
                    is_public: newVisibility
                });
                
                if (response.data.success) {
                    addTestResult(`âœ… Producto ${newVisibility ? 'publicado' : 'ocultado'} exitosamente`, 'success');
                    
                    // Actualizar en el array local
                    product.is_public = newVisibility ? 1 : 0;
                } else {
                    addTestResult('âŒ Error cambiando visibilidad: ' + response.data.error, 'error');
                }
            } catch (error) {
                addTestResult('âŒ Error en test de visibilidad: ' + error.message, 'error');
            }
        }

        async function testDeleteProduct() {
            if (!authToken) {
                addTestResult('âŒ Error: Debes hacer login primero', 'error');
                return;
            }

            const confirmDelete = confirm('âš ï¸ ADVERTENCIA: Esto eliminarÃ¡ un producto REAL de la base de datos.\\n\\nÂ¿EstÃ¡s seguro de que quieres proceder?\\n\\nEste test eliminarÃ¡ el Ãºltimo producto de la lista.');
            
            if (!confirmDelete) {
                addTestResult('âŒ Test de eliminaciÃ³n cancelado por el usuario', 'info');
                return;
            }

            if (testProducts.length === 0) {
                addTestResult('âš ï¸ Primero ejecuta "Test API Mis Productos" para cargar productos', 'error');
                return;
            }

            try {
                // Usar el Ãºltimo producto para no afectar tanto
                const product = testProducts[testProducts.length - 1];
                
                addTestResult(`ğŸ—‘ï¸ ELIMINANDO producto ${product.product_code}...`, 'info');
                
                const response = await axios.delete(`/api/me/projects/${product.project_id}/products/${product.id}`);
                
                if (response.data.success) {
                    addTestResult(`âœ… Producto "${product.product_code}" eliminado exitosamente`, 'success');
                    
                    // Remover del array local
                    testProducts = testProducts.filter(p => p.id !== product.id);
                    addTestResult(`ğŸ“Š Productos restantes: ${testProducts.length}`, 'info');
                } else {
                    addTestResult('âŒ Error eliminando producto: ' + response.data.error, 'error');
                }
            } catch (error) {
                addTestResult('âŒ Error en test de eliminaciÃ³n: ' + error.message, 'error');
            }
        }

        // Inicializar estado de autenticaciÃ³n
        updateAuthStatus();
        
        // Mostrar instrucciones iniciales
        addTestResult('=== TEST DE FUNCIONALIDAD "MIS PRODUCTOS" ===', 'info');
        addTestResult('1. Haz click en "Hacer Login" para autenticarte', 'info');
        addTestResult('2. Usa "Test API Mis Productos" para cargar datos', 'info');
        addTestResult('3. Prueba los tests especÃ­ficos de funcionalidad', 'info');
        addTestResult('4. Accede al Dashboard para ver la nueva secciÃ³n "Mis Productos"', 'info');
    </script>
</body>
</html>